# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

# Pull request against these branches will trigger this build
pr:
- main
- staging

# Any commit to this branch will trigger the build.
trigger:
- staging
- main

variables:
- group: LinuxAgentPool

jobs:
- job: unit
  displayName: "Unit Tests for Linux Spark Notebooks"
  timeoutInMinutes: 20 # how long to run the job before automatically cancelling
  pool:
    name: $(Agent_Pool)

  steps:
  - bash: |
      echo "##vso[task.prependpath]/data/anaconda/bin"
      conda create -fyn reco_unit_notebooks_spark python=3.6
    displayName: Create Conda Env
  
  - script: |
      eval "$(conda shell.bash hook)"
      conda activate reco_unit_notebooks_spark
      export PYSPARK_PYTHON=`which python`
      export PYSPARK_DRIVER_PYTHON=`which python`
      pip install .[test,spark,examples]
      pytest tests/unit -m "notebooks and spark and not gpu" \
        --durations 0 \
        --junitxml=reports/test-unit-notebook-linux-spark.xml
    displayName: 'Run Tests'

  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    inputs:
      testResultsFiles: '**/test-*.xml'
      failTaskOnFailedTests: true
    condition: succeededOrFailed()

  - script: |
      conda env remove -n reco_unit_notebooks_spark
    workingDirectory: tests
    displayName: 'Remove Conda Env'
    continueOnError: true
    condition: succeededOrFailed()